<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Food Court</title>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Teachers:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
<style>
:root {
  --rojo:#93140d;
  --verde:#28a745;
  --azul:#007bff;
  --texto:#020202;
  --texto-sec:#ccc;
}

body, html {
  margin:0; padding:0; box-sizing:border-box;
  font-family:'Teachers';
  background: url(/assets/fondo1.png);
  background-size: contain;       
  background-position: center;
  color: var(--texto);
  min-height: 100vh;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: var(--rojo);
  color: white;
  flex-wrap: wrap;
}
header .date-info {
  font-size: 0.9rem;
  opacity: 0.85;
}
header .logo-center {
  text-align: center;
  flex: 1;
}
header .logo img { display:block;  }
header .restaurant-name { font-weight:600; font-size:1.1rem; margin-top:4px; }

.container {
  max-width:700px;
  margin:30px auto;
  padding:0 16px;
}

.empty {
  text-align:center;
  padding:60px 20px;
  color: var(--texto-sec);
}
.empty i { font-size:4.5rem; opacity:0.4; margin-bottom:20px; }

.pedido-card {
  background: rgba(255, 255, 255, 0.85);
  border-radius:20px;
  padding:20px 24px;
  margin:20px 0;
  border-left:5px solid var(--rojo);
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  transition: transform 0.2s ease;
}
.pedido-card:hover { transform: translateY(-3px); }

.detalle {
  margin:8px 0; line-height:1.4;
}

.btn {
  color: var(--texto);
  border:none;
  padding:12px 22px;
  font-size:1.05rem;
  border-radius:12px;
  cursor:pointer;
  margin-top:16px;
  transition: all 0.3s ease;
}
.btn-aceptar { background: var(--azul); }
.btn-aceptar:hover { transform: translateY(-2px); box-shadow:0 6px 15px rgba(0,123,255,0.4); }
.btn-entregado { background: var(--verde); }
.btn-entregado:hover { transform: translateY(-2px); box-shadow:0 6px 15px rgba(40,167,69,0.4); }

.status {
  padding:6px 14px;
  border-radius:20px;
  font-size:0.9rem;
}
.disponible { background:var(--verde); }
.ocupado { background:var(--rojo); }

.error {
  background:var(--rojo);
  padding:18px 22px;
  border-radius:12px;
  text-align:center;
  margin:20px 0;
  font-weight:600;
}

body::-webkit-scrollbar { width:6px; }
body::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:3px; }

@media (max-width: 768px) {
  header {
    flex-direction: column;
    text-align: center;
  }
  header .date-info {
    text-align: center;
    margin-top: 8px;
  }
}

@media (max-width: 480px) {
  .pedido-card {
    padding: 16px 12px;
  }
  .detalle {
    font-size: 0.9rem;
  }
  .btn {
    font-size: 1rem;
    padding: 10px 18px;
  }
  .empty i {
    font-size: 3rem;
  }
  .container {
    width: 95%;
    margin: 20px auto;
  }
}
</style>
</head>
<body>
  <div id="app">

    <header>
      <div class="logo-center">
        <div class="logo">
          <img src="/assets/logo1.png" width="180" height="100">
        </div>
      </div>
      <div class="date-info">
        Fecha: {{ fechaHoy }} <br>
        Hora: {{ hora }} <br>
        Repartidor: {{ repartidorNombre }}
      </div>
    </header>

    <div class="container">

      <div v-if="error" class="error">
        <h3>Problema</h3>
        <p>{{ error }}</p>
        <button class="btn" style="background:#e2b93d;color:#000;" @click="volverLogin">
          Volver al Login
        </button>
      </div>

      <div v-else-if="cargando" class="empty">
        <p>Cargando...</p>
      </div>

      <div v-else-if="!pedido" class="empty">
        <i class="fa-solid fa-motorcycle"></i>
        <h2>Estás disponible</h2>
        <p>Esperando asignación...</p>
      </div>

      <div v-else class="pedido-card">
        <h2>
          Pedido #{{ pedido.id_pedido }}
          <span v-if="pedido.estado === 'L'">(Nuevo)</span>
          <span v-else-if="pedido.estado === 'C'">(En curso)</span>
        </h2>

        <div class="detalle"><strong>Restaurante:</strong> {{ pedido.nombre_restaurante || '—' }}</div>
        <div class="detalle"><strong>Dirección:</strong> {{ pedido.ubicacion || '—' }}</div>
        <div class="detalle"><strong>Total:</strong> Bs {{ Number(pedido.total || 0).toFixed(2) }}</div>
        <div class="detalle"><strong>Pago:</strong> {{ pedido.metodo_Pago || '?' }}</div>

        <div v-if="pedido.estado === 'L'">
          <button class="btn btn-aceptar" @click="pedidoRecogido">Pedido recogido</button>
        </div>

        <div v-else-if="pedido.estado === 'C'">
          <button class="btn btn-entregado" @click="marcarEntregado">Marcar como Entregado</button>
          <button class="btn btn-aceptar" @click="toggleMapa" style="margin-left:10px;">
            {{ mostrarMapa ? 'Ocultar mapa' : 'Ver en mapa' }}
          </button>

          <div v-if="mostrarMapa" id="map" style="width:100%; height:300px; margin-top:20px; border-radius:12px;"></div>
        </div>

      </div>
    </div>
  </div>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const { createApp, ref, onMounted, nextTick } = Vue;

createApp({
  setup() {
    const pedido = ref(null);
    const cargando = ref(true);
    const error = ref('');
    const repartidorNombre = ref('');
    const mostrarMapa = ref(false);

    let mapa = null;
    let marcadorCliente = null;
    let marcadorRepartidor = null;
    let ruta = null;
    const fechaHoy = ref(new Date().toLocaleDateString('es-BO')); 
    const hora = ref('');

    const tick = () => {
      hora.value = new Date().toLocaleTimeString('es-BO', { hour12: false });
    };
    tick();
    setInterval(tick, 1000);

    const usuario = JSON.parse(localStorage.getItem('usuarioLogueado'));
    if (!usuario || usuario.rol != 2) {
      error.value = 'No se encontró sesión de repartidor.';
      return { error, volverLogin: () => window.location.href = '../index.html' };
    }
    const repartidorCI = usuario.ci;

    const cargarNombreRepartidor = async () => {
      try {
        const res = await fetch(`/backend/repartidor/menurepartidor.php?action=nombre&ci=${repartidorCI}`);
        const data = await res.json();
        if (data.success && data.repartidor) {
          const r = data.repartidor;
          repartidorNombre.value = [r.nom1,r.nom2,r.ap1,r.ap2].filter(n=>n).join(' ');
        } else repartidorNombre.value = 'Repartidor';
      } catch {
        repartidorNombre.value = 'Repartidor';
      }
    };

    const cargarEstado = async () => {
      try {
        const res = await fetch(`/backend/repartidor/menurepartidor.php?action=estado&ci=${repartidorCI}`);
        const data = await res.json();
        pedido.value = data.pedido || null;
        if (!pedido.value) mostrarMapa.value = false;
      } catch {
        error.value = 'Error al cargar estado';
      } finally {
        cargando.value = false;
      }
    };

    const toggleMapa = async () => {
      mostrarMapa.value = !mostrarMapa.value;
      if (mostrarMapa.value && pedido.value) {
        await nextTick(); 
        mostrarPedidoMapa();
      }
    };

    const mostrarPedidoMapa = () => {
      if (!pedido.value) return;

      const latCliente = parseFloat(pedido.value.lat_destino);
      const lngCliente = parseFloat(pedido.value.lng_destino);

      if (isNaN(latCliente) || isNaN(lngCliente)) return alert('No hay coordenadas válidas del pedido');

      const mapDiv = document.getElementById('map');
      if (!mapDiv) return;

      navigator.geolocation.getCurrentPosition(pos => {
        const latRepartidor = pos.coords.latitude;
        const lngRepartidor = pos.coords.longitude;

        if (!mapa) {
          mapa = L.map('map').setView([latCliente, lngCliente], 14);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(mapa);
        } else {
          mapa.setView([latCliente, lngCliente], 14);
        }

        if (!marcadorCliente) {
          marcadorCliente = L.marker([latCliente, lngCliente]).addTo(mapa).bindPopup('Destino del cliente').openPopup();
        } else {
          marcadorCliente.setLatLng([latCliente, lngCliente]);
        }

        if (!marcadorRepartidor) {
          marcadorRepartidor = L.marker([latRepartidor, lngRepartidor], {icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // icono moto
            iconSize: [32,32]
          })}).addTo(mapa).bindPopup('Tú estás aquí').openPopup();
        } else {
          marcadorRepartidor.setLatLng([latRepartidor, lngRepartidor]);
        }

        if (ruta) {
          mapa.removeControl(ruta);
        }
        ruta = L.Routing.control({
          waypoints: [
            L.latLng(latRepartidor, lngRepartidor),
            L.latLng(latCliente, lngCliente)
          ],
          lineOptions: { styles: [{color: 'blue', weight: 4}] },
          createMarker: () => null, 
          addWaypoints: false,
          routeWhileDragging: false
        }).addTo(mapa);

      }, () => {
        alert('No se pudo obtener tu ubicación. Asegúrate de habilitar GPS.');
      }, { enableHighAccuracy: true });
    };

    const pedidoRecogido = async () => {
      if (!confirm('¿Pedido recogido?')) return;
      try {
        const res = await fetch(`/backend/repartidor/menurepartidor.php?action=recogido&ci=${repartidorCI}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ id_pedido: pedido.value.id_pedido })
        });
        const r = await res.json();
        if (r.success) await cargarEstado();
      } catch { alert('Error de conexión'); }
    };

    const marcarEntregado = async () => {
      if (!confirm('¿Entregado?')) return;
      try {
        const res = await fetch(`/backend/repartidor/menurepartidor.php?action=entregado&ci=${repartidorCI}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ id_pedido: pedido.value.id_pedido })
        });
        const r = await res.json();
        if (r.success) {
          mostrarMapa.value = false;
          await cargarEstado();
        }
      } catch { alert('Error de conexión'); }
    };

    onMounted(() => {
      cargarNombreRepartidor();
      cargarEstado();
      setInterval(cargarEstado, 8000);
    });

    return {
      pedido,
      fechaHoy,
      hora,
      cargando,
      error,
      repartidorNombre,
      mostrarMapa,
      pedidoRecogido,
      marcarEntregado,
      volverLogin: () => window.location.href = '/index.html'
    };
  }
}).mount('#app');
</script>

</body>
</html>
