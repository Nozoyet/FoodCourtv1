<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoodCourt - Registro de Cliente</title>
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.runtime.global.prod.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #1e1e24;
      background-image: url('media/fondo2.jpg');
      min-height: 100dvh;
      background-size: contain;    
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff8f0;
      padding: 15px;
    }
    .register-container {
      background: #fdf7f0;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
      width: 100%;
      max-width: 480px;
      padding: 3rem 2.5rem;
      text-align: center;
    }
    .logo {
      padding: -2px;
      border: double;
      background-color: #e5a657;
      border-color: #91240c;
      border-width: 8px;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.6rem;
      color: #1e1e24;
      margin-bottom: 1rem;
    }
    input, select {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 1.2rem;
      border: none;
      border-radius: 12px;
      background: #2c2c3a;
      color: #fff8f0;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 3px #ffcf99;
      background: #33333b;
    }
    .error {
      color: #c44e4e;
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0.5rem 0 0.5rem;
      min-height: 1.3rem;
    }
    .success {
      color: #578559;
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    .btn-register {
      background: linear-gradient(135deg, #ffcf99, #ffb366);
      color: #1e1e24;
      border: none;
      padding: 14px;
      width: 100%;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
    }
    .btn-register:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(255,207,153,0.4);
    }
    .btn-register:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .login-link {
      display: block;
      margin-top: 1rem;
      color: #111d4a;
      text-decoration: none;
      font-size: 0.95rem;
    }
    .login-link:hover {
      text-decoration: underline;
    }
    .button-search{
      padding: 0 16px;
              border-radius: 12px;
              border: none;
              background: #ffb366;
              color: #1e1e24;
              font-weight: 600;
              cursor: pointer;
    }
    .button-search:hover{
      background: #ce8f50;
      color: #fdf7f0;
      transform: translateY(-3px);
    }
    .button-confirm{
      padding: 0 16px;
              border-radius: 12px;
              border: none;
              background: #578559;
              color: #fdf7f0;
              font-weight: 600;
              cursor: pointer;
    }
    .button-confirm:hover{
      background: #436b43;
      color: #fdf7f0;
      transform: translateY(-3px);
    }
              
  </style>
</head>
<body>
<div id="app">
  <div class="register-container">
    <div class="logo"><img src="assets/logo1.png" width="290" height="180"></div>
    <h2>Registro de Cliente</h2>

    <form @submit.prevent="registrar">
      <input type="text" v-model="form.CI_C" placeholder="Cédula de Identidad (CI)" required maxlength="11" minlength="7">
      <input type="text" v-model="form.usuario" placeholder="Usuario" required>
      <input type="password" v-model="form.contrasena" placeholder="Contraseña" required>
      <input type="password" v-model="form.contrasena_confirm" placeholder="Confirmar contraseña" required>

      <input type="text" v-model="form.nom1" placeholder="Primer nombre" required>
      <input type="text" v-model="form.nom2" placeholder="Segundo nombre (opcional)">
      <input type="text" v-model="form.ap1" placeholder="Primer apellido" required>
      <input type="text" v-model="form.ap2" placeholder="Segundo apellido (opcional)">

      <input type="email" v-model="form.email" placeholder="Correo electrónico" required>
      <input type="tel" v-model="form.telefono" placeholder="Teléfono" required maxlength="8" minlength="8">
      <div style="display:flex; gap:8px; margin-bottom:1rem;">
        <input
          type="text"
          v-model="form.direccion"
          placeholder="Buscar Dirección"
          style="margin-bottom:0;"
          required
        >
          <button class="button-search" type="button" @click="buscarDireccion">
            Buscar
          </button>
          <button class="button-confirm" type="button" @click="confirmarDireccion">
            Confirmar
          </button>

      </div>
      <div id="map" style="height: 280px; border-radius: 12px; margin-bottom: 1rem;"></div>

      <select v-model="form.sexo">
        <option value="" disabled>Género</option>
        <option value="1">Masculino</option>
        <option value="0">Femenino</option>
        <option value="2">No binario</option>
        <option value="3">Otro</option>
      </select>

      <input type="date" v-model="form.f_Na" placeholder="Fecha de nacimiento">

      <p class="error">{{ mensajeError }}</p>
      <p v-if="mensajeSuccess" class="success">{{ mensajeSuccess }}</p>

      <button type="submit" class="btn-register" :disabled="cargando || !formValido">
        {{ cargando ? 'Registrando...' : 'Registrarse' }}
      </button>
    </form>

    <a href=index.html" class="login-link">¿Cliente frecuente? Inicia sesión</a>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
  setup() {
    const form = ref({
      CI_C: '',
      usuario: '',
      contrasena: '',
      contrasena_confirm: '',
      nom1: '',
      nom2: '',
      ap1: '',
      ap2: '',
      email: '',
      telefono: '',
      direccion: '',
      sexo: '',
      f_Na: '',
      latitud: null,
      longitud: null,
      id_rol: 3  
    });

    const mensajeError = ref('');
    const mensajeSuccess = ref('');
    const cargando = ref(false);
    let map;
    let marker;

    onMounted(() => {
      map = L.map('map', {
        maxBounds: [
          [-16.525, -68.150], 
          [-16.480, -68.105]  
        ],
        maxBoundsViscosity: 1.0
      }).setView([-16.500, -68.120], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      L.rectangle([[-16.525, -68.150], [-16.480, -68.105]], {color: "#ff7800", weight: 2, fillOpacity: 0.1}).addTo(map);

      map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        form.value.latitud = lat;
        form.value.longitud = lng;

        marker
          ? marker.setLatLng([lat, lng])
          : marker = L.marker([lat, lng]).addTo(map);
      });
    });

    const buscarDireccion = async () => {
      if (!form.value.direccion) return;

      mensajeError.value = '';

      try {
        const res = await fetch(
          `/backend/buscardireccion.php?q=${encodeURIComponent(form.value.direccion)}`
        );
        const data = await res.json();

        if (!data.length) {
          mensajeError.value = 'Dirección no encontrada en La Paz';
          return;
        }

        const lat = parseFloat(data[0].lat);
        const lng = parseFloat(data[0].lon);

        form.value.latitud = lat;
        form.value.longitud = lng;

        map.setView([lat, lng], 17);

        marker
          ? marker.setLatLng([lat, lng])
          : marker = L.marker([lat, lng]).addTo(map);

      } catch (err) {
        console.error(err);
        mensajeError.value = 'Error al buscar la dirección';
      }
    };

    const direccionConfirmada = ref(false);

    const confirmarDireccion = async () => {
      if (!form.value.latitud || !form.value.longitud) {
        mensajeError.value = 'Primero selecciona la dirección en el mapa';
        direccionConfirmada.value = false;
        return;
      }

      const lat = form.value.latitud;
      const lng = form.value.longitud;
      const SW = [-16.525, -68.150];
      const NE = [-16.480, -68.105];

      if (lat < SW[0] || lat > NE[0] || lng < SW[1] || lng > NE[1]) {
        mensajeError.value = 'La dirección está fuera de la zona sur permitida';
        direccionConfirmada.value = false;
        return;
      }

      try {
        const res = await fetch(`../backend/reverse.php?lat=${lat}&lon=${lng}`);
        const data = await res.json();

        if (data && data.display_name) {
          form.value.direccion = data.display_name; 
          direccionConfirmada.value = true;
          mensajeSuccess.value = 'Dirección confirmada';
          mensajeError.value = '';
        } else {
          direccionConfirmada.value = false;
          mensajeError.value = 'No se pudo obtener la dirección completa';
        }
      } catch (err) {
        console.error(err);
        direccionConfirmada.value = false;
        mensajeError.value = 'Error al confirmar la dirección';
      }
    };

    const formValido = computed(() => {
      return form.value.CI_C.trim() &&
             form.value.usuario.trim() &&
             form.value.contrasena &&
             form.value.contrasena === form.value.contrasena_confirm &&
             form.value.nom1.trim() &&
             form.value.ap1.trim() &&
             form.value.email.trim() &&
             form.value.telefono.trim() &&
             form.value.direccion.trim();
    });

    const registrar = async () => {
      mensajeError.value = '';
      mensajeSuccess.value = '';
      cargando.value = true;

      if (form.value.contrasena !== form.value.contrasena_confirm) {
        mensajeError.value = 'Las contraseñas no coinciden';
        cargando.value = false;
        return;
      }
      if (!direccionConfirmada.value) {
        mensajeError.value = 'Debes confirmar tu dirección antes de registrarte';
        cargando.value = false;
        return;
      }

      try {
        const res = await fetch('/backend/registro.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            CI_C: form.value.CI_C.trim(),
            usuario: form.value.usuario.trim(),
            contrasena: form.value.contrasena,
            nom1: form.value.nom1.trim(),
            nom2: form.value.nom2.trim(),
            ap1: form.value.ap1.trim(),
            ap2: form.value.ap2.trim(),
            email: form.value.email.trim(),
            telefono: form.value.telefono.trim(),
            direccion: form.value.direccion.trim(),
            sexo: form.value.sexo || null,
            f_Na: form.value.f_Na || null,
            latitud: form.value.latitud,
            longitud: form.value.longitud,
            id_rol: 3
          })
        });

        const data = await res.json();

        if (data.success) {
          mensajeSuccess.value = '¡Registro exitoso! Redirigiendo al login...';
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        } else {
          mensajeError.value = data.message || 'Error al registrar. Intenta de nuevo.';
        }
      } catch (err) {
        mensajeError.value = 'Error de conexión. Verifica tu internet.';
        console.error(err);
      } finally {
        cargando.value = false;
      }
    };

    return { 
      form, 
      mensajeError, 
      mensajeSuccess, 
      cargando, 
      formValido, 
      registrar, 
      buscarDireccion,
      confirmarDireccion,  
      direccionConfirmada  
    };
  }
}).mount('#app');
</script>

</body>
</html>